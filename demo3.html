<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>排班表 + PDF + 圓餅圖 + 長條圖</title>
<style>
  body { font-family: Arial; padding: 20px; }
  .input-section { margin-bottom: 20px; }
  #nameInput { padding: 5px; }
  #addBtn, #downloadPdfBtn { padding: 5px 10px; margin-left: 5px; }

  .container { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 20px; }
  .person { 
    padding: 5px 10px; 
    color: white; 
    cursor: grab; 
    border-radius: 5px; 
    margin-bottom: 5px; 
    user-select: none; 
    display: inline-block; 
    white-space: nowrap;
  }
  table { border-collapse: collapse; width: 100%; table-layout: auto; margin-bottom: 20px; }
  th, td { border: 1px solid #ccc; height: 60px; text-align: center; vertical-align: middle; }
  th:first-child, td:first-child { white-space: nowrap; width: 1%; }
  th:not(:first-child), td:not(:first-child) { width: calc((100% - 1%) / 7); }
  .shift { min-height: 50px; background: #f9f9f9; position: relative; }
  
  .charts-container { display: flex; gap: 30px; align-items: flex-start; }
  .chart-section { flex: 1; }
</style>
</head>
<body>

<div class="input-section">
  <input type="text" id="nameInput" placeholder="輸入人名">
  <button id="addBtn">新增</button>
  <button id="downloadPdfBtn">下載 PDF</button>
</div>

<div class="container" id="peopleContainer"></div>

<table id="scheduleTable">
  <tr>
    <th>星期</th>
    <th>一</th>
    <th>二</th>
    <th>三</th>
    <th>四</th>
    <th>五</th>
    <th>六</th>
    <th>日</th>
  </tr>
  <tr>
    <td>早班</td>
    <td class="shift" ondrop="drop(event)" ondragover="allowDrop(event)"></td>
    <td class="shift" ondrop="drop(event)" ondragover="allowDrop(event)"></td>
    <td class="shift" ondrop="drop(event)" ondragover="allowDrop(event)"></td>
    <td class="shift" ondrop="drop(event)" ondragover="allowDrop(event)"></td>
    <td class="shift" ondrop="drop(event)" ondragover="allowDrop(event)"></td>
    <td class="shift" ondrop="drop(event)" ondragover="allowDrop(event)"></td>
    <td class="shift" ondrop="drop(event)" ondragover="allowDrop(event)"></td>
  </tr>
  <tr>
    <td>晚班</td>
    <td class="shift" ondrop="drop(event)" ondragover="allowDrop(event)"></td>
    <td class="shift" ondrop="drop(event)" ondragover="allowDrop(event)"></td>
    <td class="shift" ondrop="drop(event)" ondragover="allowDrop(event)"></td>
    <td class="shift" ondrop="drop(event)" ondragover="allowDrop(event)"></td>
    <td class="shift" ondrop="drop(event)" ondragover="allowDrop(event)"></td>
    <td class="shift" ondrop="drop(event)" ondragover="allowDrop(event)"></td>
    <td class="shift" ondrop="drop(event)" ondragover="allowDrop(event)"></td>
  </tr>
</table>

<div class="charts-container">
  <div class="chart-section">
    <h3>圓餅圖</h3>
    <canvas id="pieChart" width="300" height="300"></canvas>
  </div>
  <div class="chart-section">
    <h3>長條圖</h3>
    <canvas id="barChart" width="400" height="300"></canvas>
  </div>
</div>

<!-- 引入 js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
const addBtn = document.getElementById('addBtn');
const nameInput = document.getElementById('nameInput');
const peopleContainer = document.getElementById('peopleContainer');
const downloadBtn = document.getElementById('downloadPdfBtn');

const colors = ['#e6194b','#3cb44b','#ffe119','#4363d8','#f58231','#911eb4','#46f0f0','#f032e6','#bcf60c','#fabebe','#008080','#e6beff','#9a6324','#fffac8'];
const emojis = ['🐶','🐱','🦁','🐯','🐷','🐸','🐵','🐼','🐔','🐧','🐢','🐙','🦄','🐝'];

let usedColors = [];
let usedEmojis = [];
let usedNames = [];
let personCounter = 0;

function getUniqueColor() {
  for(let c of colors){ if(!usedColors.includes(c)){ usedColors.push(c); return c; } }
  return '#000000';
}
function getUniqueEmoji() {
  for(let e of emojis){ if(!usedEmojis.includes(e)){ usedEmojis.push(e); return e; } }
  return '❓';
}

function createPersonCard(name, emoji = null, color = null) {
  const person = document.createElement('div');
  person.className = 'person';
  person.id = 'person-' + personCounter++;
  const assignedEmoji = emoji || getUniqueEmoji();
  const assignedColor = color || getUniqueColor();
  person.textContent = assignedEmoji + ' ' + name;
  person.style.backgroundColor = assignedColor;
  person.draggable = true;

  person.ondblclick = () => {
    const parts = person.textContent.split(' ');
    const nameOnly = parts.slice(1).join(' ');
    const emojiOnly = parts[0];
    const colorOnly = person.style.backgroundColor;

    const inList = peopleContainer.contains(person);

    if(person.parentNode) person.parentNode.removeChild(person);

    if(inList){
      usedNames = usedNames.filter(n => n !== nameOnly);
      usedColors = usedColors.filter(c => c !== colorOnly);
      usedEmojis = usedEmojis.filter(e => e !== emojiOnly);

      const shifts = document.querySelectorAll('.shift .person');
      shifts.forEach(p => {
        const pParts = p.textContent.split(' ');
        const pName = pParts.slice(1).join(' ');
        if(pName === nameOnly) p.parentNode.removeChild(p);
      });
    }
    updateCharts();
  };

  person.ondragstart = (ev) => {
    ev.dataTransfer.setData("text/plain", person.id);
  };

  return person;
}

addBtn.addEventListener('click', () => {
  const name = nameInput.value.trim();
  if(!name) return;
  if(usedNames.includes(name)){
    alert("這個人名已經存在！");
    return;
  }
  usedNames.push(name);
  const person = createPersonCard(name);
  peopleContainer.appendChild(person);
  nameInput.value = '';
  updateCharts();
});

function allowDrop(ev) { ev.preventDefault(); }

function drop(ev) {
  ev.preventDefault();
  if (ev.target.firstChild) return;

  const personId = ev.dataTransfer.getData("text/plain");
  const person = document.getElementById(personId);
  if (!person) return;

  if (person.parentNode === peopleContainer) {
    const parts = person.textContent.split(' ');
    const newPerson = createPersonCard(parts.slice(1).join(' '), parts[0], person.style.backgroundColor);
    ev.target.appendChild(newPerson);
  } else {
    if (person.parentNode) person.parentNode.removeChild(person);
    ev.target.appendChild(person);
  }
  updateCharts();
}

// ===== 下載 PDF =====
downloadBtn.addEventListener('click', () => {
  const element = document.getElementById('scheduleTable'); 
  const opt = {
    margin: 0.5,
    filename: '排班表.pdf',
    image: { type: 'jpeg', quality: 0.98 },
    html2canvas: { scale: 2 },
    jsPDF: { unit: 'in', format: 'a4', orientation: 'landscape' }
  };
  html2pdf().set(opt).from(element).save();
});

// ===== 圓餅圖 =====
const ctx = document.getElementById('pieChart').getContext('2d');
const pieChart = new Chart(ctx, {
    type: 'pie',
    data: { labels: [], datasets: [{ data: [], backgroundColor: [] }] },
    options: { responsive: false, plugins: { legend: { position: 'right' } } }
});

// ===== 長條圖 =====
const barCtx = document.getElementById('barChart').getContext('2d');
const barChart = new Chart(barCtx, {
    type: 'bar',
    data: { 
        labels: [], 
        datasets: [{ 
            label: '班數',
            data: [], 
            backgroundColor: []
        }] 
    },
    options: { 
        indexAxis: 'y',
        responsive: false, 
        scales: {
            x: {
                beginAtZero: true,
                max: 14,
                ticks: {
                    stepSize: 1
                }
            }
        },
        plugins: { 
            legend: { 
                display: false 
            } 
        }
    }
});

function updateCharts() {
  const allShifts = document.querySelectorAll('.shift .person');
  const countMap = {};
  const colorMap = {};
  allShifts.forEach(p => {
    const parts = p.textContent.split(' ');
    const name = parts.slice(1).join(' ');
    countMap[name] = (countMap[name] || 0) + 1;
    colorMap[name] = p.style.backgroundColor;
  });

  const labels = Object.keys(countMap);
  const data = labels.map(l => countMap[l]);
  const colors = labels.map(l => colorMap[l]);

  // 更新圓餅圖
  pieChart.data.labels = labels;
  pieChart.data.datasets[0].data = data;
  pieChart.data.datasets[0].backgroundColor = colors;
  pieChart.update();
  
  // 更新長條圖
  barChart.data.labels = labels;
  barChart.data.datasets[0].data = data;
  barChart.data.datasets[0].backgroundColor = colors;
  barChart.update();
}

// 重新命名原本的 updatePieChart 為 updateCharts
function updatePieChart() {
  updateCharts();
}
</script>

</body>
</html>
